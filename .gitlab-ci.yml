image: openjdk:8

variables:
  APP_VERSION: "1.0.6"
  APP_NAME: 'ena-file-downloader'
  FTP_DIR: "/nfs/ftp/public/databases/ena/tools"
  APP_NAME_VERSION: ${APP_NAME}-${APP_VERSION}.zip
  FTP_STG_DIR: "/nfs/production/cochrane/ena/ftp-staging/tools"
  SCRIPT_PATH: "/nfs/production/cochrane/ena/tools/ena-file-downloader"
  SCRIPT_NAME: "copy_to_ftp.sh"


stages:
  - test
  - build
  - deploy

cache:
  paths:
    - .gradle/wrapper
    - .gradle/caches

test:
  stage: test
  before_script:
    - export GRADLE_USER_HOME=.gradle
  tags:
    - dcap-gitlab-runner
  script:
    - chmod u+x gradlew
    - ./gradlew clean test

build_prod:
  stage: build
  before_script:
    - export GRADLE_USER_HOME=.gradle
  script:
    - ./gradlew clean build -x test
  artifacts:
    paths:
      - build/dist/${APP_NAME_VERSION}
  tags:
    - dcap-gitlab-runner
  only:
    - master

deploy_prod:
  stage: deploy
  before_script:
    # Setup SSH deploy keys
    - 'which ssh-agent || ( apt-get install -qq openssh-client )'
    - eval $(ssh-agent -s)
    - ssh-add <(echo "$SSH_PRIVATE_KEY")
    - mkdir -p ~/.ssh
  script:
    - chmod u+x build/dist/${APP_NAME_VERSION}
    - scp -o StrictHostKeyChecking=no build/dist/${APP_NAME_VERSION} datalib@codon-login-01.ebi.ac.uk:${FTP_STG_DIR}
    - ssh datalib@codon-login-01.ebi.ac.uk "bsub -q datamover 'cp ${FTP_STG_DIR}/${APP_NAME_VERSION} ${FTP_DIR} && cd ${FTP_DIR} && ln -sf ${APP_NAME_VERSION} ${APP_NAME}.zip'"
  dependencies:
    - build_prod
  when: manual
  tags:
    - dcap-gitlab-runner
  only:
    - master
